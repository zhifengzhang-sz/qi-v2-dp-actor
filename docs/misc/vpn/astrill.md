## [No internet connection Ubuntu-WSL while VPN](https://superuser.com/questions/1630487/no-internet-connection-ubuntu-wsl-while-vpn)

There is an issue with DNS Forwarding in WSL2 when using VPN (see github Issue). Plus there is a issue with the Cisco AnyConnect. So here is a workaround for these problems. Should work for Ubuntu and Debian.

This solution is automatic and was created by EdwardCooke (see https://www.frakkingsweet.com/automatic-dns-configuration-with-wsl-and-anyconnect-client/). This is just the first part of his solution updating resolv.conf when starting WSL.

1. Re-enable auto generation of resolv.conf (if disabled) by commented the disable with `#`
    ```bash
    sudo nano /etc/wsl.conf
    #[network]
    #generateResolvConf = false
    ```

2. Create the script
    ```bash
    sudo nano /bin/vpn-dns.sh
    #!/bin/bash

    echo "Getting current DNS servers, this takes a couple of seconds"

    /mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe -Command '
    $ErrorActionPreference="SilentlyContinue"
    Get-NetAdapter -InterfaceDescription "Cisco AnyConnect*" | Get-DnsClientServerAddress | Select -ExpandProperty ServerAddresses
    Get-NetAdapter | ?{-not ($_.InterfaceDescription -like "Cisco AnyConnect*") } | Get-DnsClientServerAddress | Select -ExpandProperty ServerAddresses
    ' | \
            awk 'BEGIN { print "# Generated by vpn fix func on", strftime("%c"); print } { print "nameserver", $1 }' | \
            tr -d '\r' > /etc/resolv.conf
    clear
    ```

3. Make it **executable/run** as sudo
    ```bash
    sudo chmod +x /bin/vpn-dns.sh
    echo "$(whoami) ALL=(ALL) NOPASSWD: /bin/vpn-dns.sh" | sudo tee /etc/sudoers.d/010-$(whoami)-vpn-dns
    ```

4. Make it run on **wsl startup**
    ```bash
    echo "sudo /bin/vpn-dns.sh" | sudo tee /etc/profile.d/vpn-dns.sh
    ```

    You can also run it manually: 
    ```bash
    sudo /bin/vpn-dns.sh
    ```